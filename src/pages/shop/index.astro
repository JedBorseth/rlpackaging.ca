---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
// @ts-ignore - Im upset there isnt any types for this
import { Client, Environment } from "square";
import type { SearchCatalogTypes } from "../../squareTypes";

const date = new Date();

if (import.meta.env.SQUARE_ACCESS_TOKEN === undefined) {
  console.log("No Square Access Token");
  return new Response("No Square Access Token", { status: 500 });
}
const client = await new Client({
  accessToken: import.meta.env.SQUARE_ACCESS_TOKEN,
  environment: Environment.Production,
});
const response: SearchCatalogTypes = await client.catalogApi.searchCatalogItems(
  {}
);
if (!response.result.items || !response) {
  console.log("No Items");
  return new Response("Cound Not Find Any Products From Square", {
    status: 500,
  });
}
const items = response.result.items;

const fetchInventory = async (item: any) => {
  return await client.inventoryApi.retrieveInventoryCount(
    item.itemData?.variations[0].id,
    "LT6VCG48B673C"
  );
};
---

<Layout title="R&L Packaging">
  <header class="sticky top-0 z-50">
    <Navbar />
  </header>
  <main>
    <div class="flex flex-wrap gap-10 p-20 min-h-screen">
      {
        items &&
          items.map(async (item) => {
            const price: bigint =
              item.itemData?.variations[0].itemVariationData?.priceMoney
                ?.amount;
            const inventory = await fetchInventory(item);
            return (
              <div class="w-1/4 bg-red-500 h-48 flex rounded shadow-2xl flex-wrap relative">
                <h2 class="w-full text-center text-2xl">
                  {item.itemData?.name}
                </h2>
                <p class="w-full">
                  {item.itemData?.description
                    ? item.itemData.description
                    : "No Description For Product"}
                </p>
                <h3>Stock: {inventory.result.counts[0].quantity}</h3>
                <a
                  class="btn btn-primary absolute bottom-0 right-0"
                  href={`/shop/${item.id}`}
                >
                  {(Number(price) / 100).toLocaleString("en-US", {
                    style: "currency",
                    currency: "CAD",
                  })}
                </a>
              </div>
            );
          })
      }
    </div>
  </main>

  <footer
    class="footer footer-center p-10 bg-base-200 text-base-content rounded"
  >
    <div class="grid grid-flow-col gap-4">
      <a class="link link-hover home-scroll">Home</a>
      <a class="link link-hover about-scroll">About</a>
      <a class="link link-hover history-scroll">History</a>
      <a class="link link-hover contact-scroll">Contact</a>
    </div>
    <div>
      <p>
        Copyright Â© {date.getFullYear()} - All right reserved by R&L Packaging
      </p>
      <p class="text-xs">
        Website designed by <a href="https://jedborseth.com">Jed Borseth</a>
      </p>
    </div>
  </footer>
</Layout>
