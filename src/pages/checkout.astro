---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import type { retrieveCatalogTypes, SearchCatalogTypes } from "../squareTypes";
import { Client, Environment } from "square";

const date = new Date();

if (import.meta.env.SQUARE_ACCESS_TOKEN === undefined) {
  console.log("No Square Access Token");
  return new Response("No Square Access Token", { status: 500 });
}
const client = await new Client({
  accessToken: import.meta.env.SQUARE_ACCESS_TOKEN,
  environment: Environment.Production,
});

if (
  Astro.url.searchParams.get("id") === null ||
  Astro.url.searchParams.get("quantity") === null
)
  return Astro.redirect("/shop");
const getItem = async () => {
  try {
    const response = await client.catalogApi.retrieveCatalogObject(
      Astro.url.searchParams.get("id") ?? ""
    );
    return response.result;
  } catch (error: any) {
    console.log(error);
    return new Response(error, { status: 500 });
  }
};
const response: any = await getItem();
// if (!response) return Astro.redirect("/shop");

const params = Astro.url.searchParams;

const generateLink = async (id: string) => {
  try {
    const response = await client.checkoutApi.createPaymentLink({
      order: {
        locationId: "LT6VCG48B673C",
        lineItems: [
          {
            quantity: Astro.url.searchParams.get("quantity") ?? "1",
            catalogObjectId: id,
          },
        ],
      },
      checkoutOptions: {
        redirectUrl: "https://rlpackaging.ca",
        merchantSupportEmail: "orders@rlpackaging.ca",
        askForShippingAddress: true,
      },
    });
    return response.result.paymentLink?.url;
  } catch (error) {
    console.log(error);
  }
};
const link: string | undefined = await generateLink(
  response.object.itemData.variations[0].id
);
---

<Layout title="R&L Packaging">
  <header class="sticky top-0 z-50">
    <Navbar />
  </header>
  <main class="min-h-screen">
    Cart: {response.object.itemData.name} x {params.get("quantity")}

    <a href={link}>Buy Now!</a>
  </main>

  <footer
    class="footer footer-center p-10 bg-base-200 text-base-content rounded"
  >
    <div class="grid grid-flow-col gap-4">
      <a class="link link-hover home-scroll">Home</a>
      <a class="link link-hover about-scroll">About</a>
      <a class="link link-hover history-scroll">History</a>
      <a class="link link-hover contact-scroll">Contact</a>
    </div>
    <div>
      <p>
        Copyright Â© {date.getFullYear()} - All right reserved by R&L Packaging
      </p>
      <p class="text-xs">
        Website designed by <a href="https://jedborseth.com">Jed Borseth</a>
      </p>
    </div>
  </footer>
</Layout>
